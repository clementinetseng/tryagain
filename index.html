<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢¨æ§è¦å‰‡ç®¡ç† - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* è‡ªå®šç¾©åˆ‡æ›é–‹é—œæ¨£å¼ */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #34d399;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #34d399;
        }
        /* åˆ†æ®µæ§ä»¶æ¨£å¼ */
        .segment-control input:checked + label {
            background-color: #fff;
            color: #1e40af;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- é é¢æ¨™é¡Œ -->
        <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸª é¢¨æ§è¦å‰‡ç®¡ç†</h1>

        <!-- æœå°‹èˆ‡ç¯©é¸ -->
        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">æœå°‹èˆ‡ç¯©é¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <input id="search-input" type="text" placeholder="è¼¸å…¥æœƒå“¡å¸³è™Ÿæˆ– IP ä½å€..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                
                <select id="filter-target-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">ç›®æ¨™é¡å‹: å…¨éƒ¨</option>
                    <option value="æœƒå“¡å¸³è™Ÿ">æœƒå“¡å¸³è™Ÿ</option>
                    <option value="IP ä½å€">IP ä½å€</option>
                </select>

                <select id="filter-action" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">åŸ·è¡Œå‹•ä½œ: å…¨éƒ¨</option>
                    <option value="ç¦æ­¢å‡ºæ¬¾">ç¦æ­¢å‡ºæ¬¾</option>
                    <option value="ç¦æ­¢å­˜æ¬¾">ç¦æ­¢å­˜æ¬¾</option>
                    <option value="ç¦æ­¢æ‰€æœ‰éŠæˆ²">ç¦æ­¢æ‰€æœ‰éŠæˆ²</option>
                    <option value="ç¦æ­¢é ˜å–å„ªæƒ ">ç¦æ­¢é ˜å–å„ªæƒ </option>
                    <option value="å¼·åˆ¶å°å…¥KYCé é¢">å¼·åˆ¶å°å…¥KYCé é¢</option>
                    <option value="ç¦æ­¢ç™»å…¥">ç¦æ­¢ç™»å…¥</option>
                    <option value="ç¦æ­¢è¨»å†Š">ç¦æ­¢è¨»å†Š</option>
                </select>

                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">ç‹€æ…‹: å…¨éƒ¨</option>
                    <option value="enabled">å•Ÿç”¨</option>
                    <option value="disabled">åœç”¨</option>
                </select>
            </div>
            <div class="flex flex-wrap items-center justify-between mt-4">
                <div class="flex items-center space-x-2">
                    <button id="search-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">æœå°‹</button>
                    <button id="reset-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">é‡è¨­</button>
                </div>
                <div class="flex items-center space-x-2 mt-4 md:mt-0">
                    <button id="export-btn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">åŒ¯å‡º CSV</button>
                    <button id="add-rule-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">æ–°å¢è¦å‰‡</button>
                </div>
            </div>
        </div>

        <!-- è¦å‰‡åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <h2 class="text-lg font-semibold text-gray-700 p-6">è¦å‰‡åˆ—è¡¨</h2>
            <div class="overflow-x-auto">
                <table class="w-full min-w-max text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">ç‹€æ…‹</th>
                            <th scope="col" class="px-6 py-3">ç›®æ¨™é¡å‹</th>
                            <th scope="col" class="px-6 py-3">ç›®æ¨™å€¼</th>
                            <th scope="col" class="px-6 py-3">åŸ·è¡Œå‹•ä½œ</th>
                            <th scope="col" class="px-6 py-3">åŸå› </th>
                            <th scope="col" class="px-6 py-3">æ›´æ–°æ™‚é–“ / æ“ä½œäºº</th>
                            <th scope="col" class="px-6 py-3 text-center">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table-body">
                        <!-- è¦å‰‡åˆ—å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            <div id="empty-state" class="hidden text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">æ‰¾ä¸åˆ°è¦å‰‡</h3>
                <p class="mt-1 text-sm text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¦å‰‡ã€‚è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–é‡è¨­ã€‚</p>
            </div>
        </div>

        <!-- æœƒå“¡å„€è¡¨æ¿é€£å‹•èªªæ˜ -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-6 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <span class="font-bold">å„€è¡¨æ¿é€£å‹•èªªæ˜ï¼š</span>
                        æœ¬ç³»çµ±å»ºç«‹çš„è¦å‰‡å°‡å³æ™‚åŒæ­¥è‡³ã€Œæœƒå“¡å„€è¡¨æ¿ã€ã€‚è‹¥æœƒå“¡å¸³è™Ÿè¢«å‘½ä¸­ï¼Œå°‡é¡¯ç¤º <span class="font-mono bg-gray-200 px-1 rounded">ğŸ”’ é¢¨éšªç®¡åˆ¶ä¸­</span> æ¨™ç±¤ã€‚è‹¥ç™»å…¥ IP è¢«å‘½ä¸­ï¼Œå°‡åœ¨ IP æ—é¡¯ç¤º <span class="font-mono bg-gray-200 px-1 rounded">âš ï¸</span> è­¦ç¤ºã€‚
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯è¦å‰‡ Modal -->
    <div id="rule-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all">
            <form id="rule-form">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-800">æ–°å¢è¦å‰‡</h3>
                </div>
                <div class="p-6 space-y-6">
                    <input type="hidden" id="rule-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™é¡å‹</label>
                        <div class="segment-control relative w-full flex rounded-lg bg-gray-200 p-1">
                            <input type="radio" id="target-type-member" name="targetType" value="æœƒå“¡å¸³è™Ÿ" class="sr-only" checked>
                            <label for="target-type-member" class="flex-1 text-center py-2 rounded-md cursor-pointer transition-colors duration-200 ease-in-out text-gray-600">æœƒå“¡å¸³è™Ÿ</label>
                            <input type="radio" id="target-type-ip" name="targetType" value="IP ä½å€" class="sr-only">
                            <label for="target-type-ip" class="flex-1 text-center py-2 rounded-md cursor-pointer transition-colors duration-200 ease-in-out text-gray-600">IP ä½å€</label>
                        </div>
                    </div>

                    <div>
                        <label for="target-value" class="block text-sm font-medium text-gray-700">ç›®æ¨™å€¼</label>
                        <textarea id="target-value" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="è¼¸å…¥æœƒå“¡å¸³è™Ÿ...&#10;æ”¯æ´æ‰¹æ¬¡æ–°å¢ï¼Œæ¯è¡Œä¸€å€‹ã€‚"></textarea>
                    </div>

                    <div>
                        <label for="action" class="block text-sm font-medium text-gray-700">åŸ·è¡Œå‹•ä½œ</label>
                        <select id="action" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="" disabled selected>è«‹é¸æ“‡ä¸€å€‹å‹•ä½œ</option>
                            <option value="ç¦æ­¢å‡ºæ¬¾">ç¦æ­¢å‡ºæ¬¾</option>
                            <option value="ç¦æ­¢å­˜æ¬¾">ç¦æ­¢å­˜æ¬¾</option>
                            <option value="ç¦æ­¢æ‰€æœ‰éŠæˆ²">ç¦æ­¢æ‰€æœ‰éŠæˆ²</option>
                            <option value="ç¦æ­¢é ˜å–å„ªæƒ ">ç¦æ­¢é ˜å–å„ªæƒ </option>
                            <option value="å¼·åˆ¶å°å…¥KYCé é¢">å¼·åˆ¶å°å…¥KYCé é¢</option>
                            <option value="ç¦æ­¢ç™»å…¥">ç¦æ­¢ç™»å…¥</option>
                            <option value="ç¦æ­¢è¨»å†Š">ç¦æ­¢è¨»å†Š</option>
                        </select>
                    </div>

                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-700">åŸå› </label>
                        <input id="reason" list="reason-suggestions" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="å¯é¸æ“‡é è¨­æˆ–è‡ªè¡Œè¼¸å…¥åŸå› ">
                        <datalist id="reason-suggestions">
                            <!-- é¸é …å°‡ç”± JS å‹•æ…‹æ›´æ–° -->
                        </datalist>
                    </div>
                    
                    <div>
                        <label for="expiry-date" class="block text-sm font-medium text-gray-700">æœ‰æ•ˆæœŸé™</label>
                        <div class="flex items-center mt-1 space-x-4">
                            <input type="date" id="expiry-date" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm disabled:bg-gray-100">
                            <div class="flex items-center">
                                <input id="permanent-expiry" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="permanent-expiry" class="ml-2 block text-sm text-gray-900">æ°¸ä¹…æœ‰æ•ˆ</label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">å–æ¶ˆ</button>
                    <button type="submit" id="save-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">ç¢ºèªåˆªé™¤</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™æ¢è¦å‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">ç¢ºèªåˆªé™¤</button>
                <button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">å–æ¶ˆ</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- åˆå§‹è³‡æ–™ ---
            let rulesData = [
                { id: 1, status: 'enabled', targetType: 'æœƒå“¡å¸³è™Ÿ', targetValue: 'user_cheater01', action: 'ç¦æ­¢å‡ºæ¬¾', reason: 'å¤šå¸³è™Ÿå¥—åˆ©è¡Œç‚º', updated: '2025/08/05 14:30', operator: 'risk_manager_A' },
                { id: 2, status: 'enabled', targetType: 'IP ä½å€', targetValue: '192.168.1.101', action: 'ç¦æ­¢è¨»å†Š', reason: 'åƒåœ¾è¨»å†Šè¡Œç‚º', updated: '2025/08/05 11:20', operator: 'risk_manager_B' },
                { id: 3, status: 'disabled', targetType: 'æœƒå“¡å¸³è™Ÿ', targetValue: 'temp_block_user', action: 'ç¦æ­¢ç™»å…¥', reason: 'å¸³è™Ÿç•°å¸¸æ´»å‹•èª¿æŸ¥', updated: '2025/08/04 18:00', operator: 'system_admin' },
                { id: 4, status: 'enabled', targetType: 'IP ä½å€', targetValue: '203.0.113.55', action: 'ç¦æ­¢ç™»å…¥', reason: 'å·²çŸ¥çš„æƒ¡æ„æ”»æ“Šä¾†æº', updated: '2025/08/03 09:10', operator: 'risk_manager_A' },
                { id: 5, status: 'enabled', targetType: 'æœƒå“¡å¸³è™Ÿ', targetValue: 'promo_abuser_99', action: 'ç¦æ­¢é ˜å–å„ªæƒ ', reason: 'æ¿«ç”¨å„ªæƒ æ´»å‹•', updated: '2025/08/02 16:45', operator: 'risk_manager_B' },
                { id: 6, status: 'enabled', targetType: 'æœƒå“¡å¸³è™Ÿ', targetValue: 'kyc_pending_01', action: 'å¼·åˆ¶å°å…¥KYCé é¢', reason: 'é«˜é¢¨éšªäº¤æ˜“è§¸ç™¼', updated: '2025/08/01 12:00', operator: 'system_auto' },
            ];

            const reasonSuggestions = {
                'ç¦æ­¢å‡ºæ¬¾': ['å¤šå¸³è™Ÿå¥—åˆ©è¡Œç‚º', 'ç–‘ä¼¼æ´—éŒ¢', 'é¢¨æ§éƒ¨é–€å¯©æ ¸'],
                'ç¦æ­¢å­˜æ¬¾': ['å­˜æ¬¾ä¾†æºå¯ç–‘', 'äº¤æ˜“å¤±æ•—æ¬¡æ•¸éå¤š'],
                'ç¦æ­¢æ‰€æœ‰éŠæˆ²': ['ä½¿ç”¨å¤–æ›ç¨‹å¼', 'é•åéŠæˆ²å…¬å¹³æ€§'],
                'ç¦æ­¢é ˜å–å„ªæƒ ': ['æ¿«ç”¨å„ªæƒ æ´»å‹•', 'ä¸ç¬¦åˆæ´»å‹•è³‡æ ¼'],
                'å¼·åˆ¶å°å…¥KYCé é¢': ['é«˜é¢¨éšªäº¤æ˜“è§¸ç™¼', 'å¸³æˆ¶è³‡è¨Šä¸å®Œæ•´'],
                'ç¦æ­¢ç™»å…¥': ['å¸³è™Ÿç•°å¸¸æ´»å‹•èª¿æŸ¥', 'é•åä½¿ç”¨è€…æ¢æ¬¾', 'å¸³è™Ÿè¢«ç›œç”¨'],
                'ç¦æ­¢è¨»å†Š': ['åƒåœ¾è¨»å†Šè¡Œç‚º', 'æƒ¡æ„IPè¨»å†Š', 'é‡è¤‡è¨»å†Š'],
            };

            // --- DOM å…ƒç´  ---
            const tableBody = document.getElementById('rules-table-body');
            const emptyState = document.getElementById('empty-state');
            const searchInput = document.getElementById('search-input');
            const filterTargetType = document.getElementById('filter-target-type');
            const filterAction = document.getElementById('filter-action');
            const filterStatus = document.getElementById('filter-status');
            const searchBtn = document.getElementById('search-btn');
            const resetBtn = document.getElementById('reset-btn');
            const addRuleBtn = document.getElementById('add-rule-btn');

            const modal = document.getElementById('rule-modal');
            const modalTitle = document.getElementById('modal-title');
            const ruleForm = document.getElementById('rule-form');
            const ruleIdInput = document.getElementById('rule-id');
            const targetTypeMemberRadio = document.getElementById('target-type-member');
            const targetTypeIpRadio = document.getElementById('target-type-ip');
            const targetValueTextarea = document.getElementById('target-value');
            const actionSelect = document.getElementById('action');
            const reasonInput = document.getElementById('reason');
            const reasonSuggestionsDatalist = document.getElementById('reason-suggestions');
            const expiryDateInput = document.getElementById('expiry-date');
            const permanentExpiryCheckbox = document.getElementById('permanent-expiry');
            const cancelBtn = document.getElementById('cancel-btn');
            const saveBtn = document.getElementById('save-btn');

            const deleteModal = document.getElementById('delete-confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            let ruleToDeleteId = null;

            // --- å‡½æ•¸ ---

            // æ¸²æŸ“è¡¨æ ¼
            const renderTable = (rules) => {
                tableBody.innerHTML = '';
                if (rules.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                emptyState.classList.add('hidden');

                rules.forEach(rule => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <label for="status-toggle-${rule.id}" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="status-toggle-${rule.id}" class="sr-only toggle-checkbox" ${rule.status === 'enabled' ? 'checked' : ''} data-id="${rule.id}">
                                    <div class="block bg-gray-300 w-12 h-6 rounded-full toggle-label transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                                <div class="ml-3 text-gray-700 text-sm font-medium">${rule.status === 'enabled' ? '<span class="text-green-600">å•Ÿç”¨</span>' : '<span class="text-gray-500">åœç”¨</span>'}</div>
                            </label>
                        </td>
                        <td class="px-6 py-4">${rule.targetType}</td>
                        <td class="px-6 py-4 font-mono text-gray-800">${rule.targetValue}</td>
                        <td class="px-6 py-4">${rule.action}</td>
                        <td class="px-6 py-4">${rule.reason}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-800">${rule.updated}</div>
                            <div class="text-xs text-gray-500">${rule.operator}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button class="font-medium text-blue-600 hover:underline mr-4 edit-btn" data-id="${rule.id}">ç·¨è¼¯</button>
                            <button class="font-medium text-red-600 hover:underline delete-btn" data-id="${rule.id}">åˆªé™¤</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            };

            // ç¯©é¸å’Œæœå°‹
            const filterAndSearch = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const targetType = filterTargetType.value;
                const action = filterAction.value;
                const status = filterStatus.value;

                const filteredRules = rulesData.filter(rule => {
                    const matchSearch = !searchTerm || rule.targetValue.toLowerCase().includes(searchTerm);
                    const matchTargetType = targetType === 'all' || rule.targetType === targetType;
                    const matchAction = action === 'all' || rule.action === action;
                    const matchStatus = status === 'all' || rule.status === status;
                    return matchSearch && matchTargetType && matchAction && matchStatus;
                });
                renderTable(filteredRules);
            };

            // é–‹å•Ÿ Modal
            const openModal = (rule = null) => {
                ruleForm.reset();
                if (rule) { // ç·¨è¼¯æ¨¡å¼
                    modalTitle.textContent = 'ç·¨è¼¯è¦å‰‡';
                    ruleIdInput.value = rule.id;
                    if (rule.targetType === 'IP ä½å€') {
                        targetTypeIpRadio.checked = true;
                    } else {
                        targetTypeMemberRadio.checked = true;
                    }
                    targetValueTextarea.value = rule.targetValue;
                    targetValueTextarea.readOnly = true;
                    targetValueTextarea.placeholder = 'ç·¨è¼¯æ¨¡å¼ä¸‹ä¸å¯ä¿®æ”¹ç›®æ¨™å€¼';
                    actionSelect.value = rule.action;
                    reasonInput.value = rule.reason;
                    // é€™è£¡å¯ä»¥åŠ å…¥æœ‰æ•ˆæœŸé™çš„é‚è¼¯
                    permanentExpiryCheckbox.checked = true; // é è¨­
                    handleExpiryDateState();
                    updateReasonSuggestions();
                } else { // æ–°å¢æ¨¡å¼
                    modalTitle.textContent = 'æ–°å¢è¦å‰‡';
                    ruleIdInput.value = '';
                    targetTypeMemberRadio.checked = true;
                    targetValueTextarea.readOnly = false;
                    targetValueTextarea.placeholder = 'è¼¸å…¥æœƒå“¡å¸³è™Ÿ...\næ”¯æ´æ‰¹æ¬¡æ–°å¢ï¼Œæ¯è¡Œä¸€å€‹ã€‚';
                    permanentExpiryCheckbox.checked = true;
                    handleExpiryDateState();
                    updateReasonSuggestions();
                }
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            // é—œé–‰ Modal
            const closeModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            // æ›´æ–°åŸå› å»ºè­°
            const updateReasonSuggestions = () => {
                const selectedAction = actionSelect.value;
                const suggestions = reasonSuggestions[selectedAction] || [];
                reasonSuggestionsDatalist.innerHTML = suggestions.map(s => `<option value="${s}"></option>`).join('');
            };

            // è™•ç†æœ‰æ•ˆæœŸé™è¼¸å…¥æ¡†ç‹€æ…‹
            const handleExpiryDateState = () => {
                expiryDateInput.disabled = permanentExpiryCheckbox.checked;
                if (permanentExpiryCheckbox.checked) {
                    expiryDateInput.value = '';
                }
            };
            
            // è™•ç†ç›®æ¨™å€¼è¼¸å…¥æ¡†çš„ placeholder
            const handleTargetValuePlaceholder = () => {
                if (targetValueTextarea.readOnly) return; // ç·¨è¼¯æ¨¡å¼ä¸‹ä¸è®Š
                if(targetTypeIpRadio.checked) {
                    targetValueTextarea.placeholder = 'è¼¸å…¥ IP ä½å€...\næ”¯æ´æ‰¹æ¬¡æ–°å¢ï¼Œæ¯è¡Œä¸€å€‹ã€‚';
                } else {
                    targetValueTextarea.placeholder = 'è¼¸å…¥æœƒå“¡å¸³è™Ÿ...\næ”¯æ´æ‰¹æ¬¡æ–°å¢ï¼Œæ¯è¡Œä¸€å€‹ã€‚';
                }
            };

            // --- äº‹ä»¶ç›£è½ ---
            searchBtn.addEventListener('click', filterAndSearch);
            resetBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterTargetType.value = 'all';
                filterAction.value = 'all';
                filterStatus.value = 'all';
                filterAndSearch();
            });
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    filterAndSearch();
                }
            });

            addRuleBtn.addEventListener('click', () => openModal());
            cancelBtn.addEventListener('click', closeModal);

            actionSelect.addEventListener('change', updateReasonSuggestions);
            permanentExpiryCheckbox.addEventListener('change', handleExpiryDateState);
            targetTypeMemberRadio.addEventListener('change', handleTargetValuePlaceholder);
            targetTypeIpRadio.addEventListener('change', handleTargetValuePlaceholder);

            // è¡¨å–®æäº¤
            ruleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = ruleIdInput.value;
                const targetValues = targetValueTextarea.value.trim().split('\n').filter(val => val);
                const newRuleData = {
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    action: actionSelect.value,
                    reason: reasonInput.value,
                    // æœ‰æ•ˆæœŸé™é‚è¼¯å¯åœ¨æ­¤æ·»åŠ 
                    updated: new Date().toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/-/g, '/') + ' ' + new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    operator: 'current_user' // æ‡‰å¾å¯¦éš›ç™»å…¥è³‡è¨Šå–å¾—
                };

                if (id) { // ç·¨è¼¯
                    const index = rulesData.findIndex(r => r.id == id);
                    if (index !== -1) {
                        rulesData[index] = { ...rulesData[index], ...newRuleData };
                    }
                } else { // æ–°å¢
                    targetValues.forEach(value => {
                        const newId = rulesData.length > 0 ? Math.max(...rulesData.map(r => r.id)) + 1 : 1;
                        rulesData.unshift({
                            id: newId,
                            status: 'enabled',
                            targetValue: value,
                            ...newRuleData
                        });
                    });
                }
                closeModal();
                filterAndSearch();
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                // alert('è¦å‰‡å·²æˆåŠŸå„²å­˜ã€‚'); // å¯¦éš›æ‡‰ç”¨ä¸­æœƒç”¨æ›´å¥½çœ‹çš„æç¤ºæ¡†
            });

            // äº‹ä»¶ä»£ç† (ç·¨è¼¯ã€åˆªé™¤ã€ç‹€æ…‹åˆ‡æ›)
            tableBody.addEventListener('click', (e) => {
                const target = e.target;
                
                // ç‹€æ…‹åˆ‡æ›
                if (target.classList.contains('toggle-checkbox')) {
                    const id = target.dataset.id;
                    const index = rulesData.findIndex(r => r.id == id);
                    if (index !== -1) {
                        rulesData[index].status = target.checked ? 'enabled' : 'disabled';
                        rulesData[index].updated = new Date().toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/-/g, '/') + ' ' + new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        rulesData[index].operator = 'current_user';
                        filterAndSearch();
                    }
                }

                // ç·¨è¼¯æŒ‰éˆ•
                if (target.classList.contains('edit-btn')) {
                    const id = target.dataset.id;
                    const rule = rulesData.find(r => r.id == id);
                    if (rule) {
                        openModal(rule);
                    }
                }

                // åˆªé™¤æŒ‰éˆ•
                if (target.classList.contains('delete-btn')) {
                    ruleToDeleteId = target.dataset.id;
                    deleteModal.classList.remove('hidden');
                    deleteModal.classList.add('flex');
                }
            });

            // åˆªé™¤ç¢ºèª Modal äº‹ä»¶
            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
                ruleToDeleteId = null;
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (ruleToDeleteId) {
                    rulesData = rulesData.filter(r => r.id != ruleToDeleteId);
                    filterAndSearch();
                    // alert('è¦å‰‡å·²æˆåŠŸåˆªé™¤ã€‚'); // å¯¦éš›æ‡‰ç”¨ä¸­æœƒç”¨æ›´å¥½çœ‹çš„æç¤ºæ¡†
                }
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
                ruleToDeleteId = null;
            });

            // --- åˆå§‹æ¸²æŸ“ ---
            renderTable(rulesData);
        });
    </script>

</body>
</html>
