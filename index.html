import React, { useState, useMemo, useCallback, useRef, useEffect } from 'react';
import { Search, RotateCcw, Plus, Edit, Trash2, X, AlertTriangle, Info, Download } from 'lucide-react';

// --- æ¨¡æ“¬è³‡æ–™ (Mock Data) ---
const initialRules = [
  { id: 1, status: 'enabled', targetType: 'member', targetValue: 'user123', action: 'ç¦æ­¢å‡ºæ¬¾', reason: 'é«˜é »ç•°å¸¸äº¤æ˜“', updatedAt: '2025-08-06 10:30', operator: 'admin_risk' },
  { id: 2, status: 'enabled', targetType: 'ip', targetValue: '192.168.1.101', action: 'ç¦æ­¢è¨»å†Š', reason: 'åƒåœ¾è¨»å†Šè¡Œç‚º', updatedAt: '2025-08-06 09:15', operator: 'system_auto' },
  { id: 3, status: 'disabled', targetType: 'member', targetValue: 'danger_player', action: 'ç¦æ­¢æ‰€æœ‰éŠæˆ²', reason: 'é•åéŠæˆ²è¦å‰‡ (æš«æ™‚)', updatedAt: '2025-08-05 14:00', operator: 'admin_risk' },
  { id: 4, status: 'enabled', targetType: 'member', targetValue: 'promo_hunter', action: 'ç¦æ­¢é ˜å–å„ªæƒ ', reason: 'æ¿«ç”¨å„ªæƒ æ¢æ¬¾', updatedAt: '2025-08-05 11:45', operator: 'admin_promo' },
  { id: 5, status: 'enabled', targetType: 'ip', targetValue: '203.0.113.55', action: 'ç¦æ­¢ç™»å…¥', reason: 'å·²çŸ¥çš„æƒ¡æ„ä¾†æº IP', updatedAt: '2025-08-04 18:20', operator: 'system_auto' },
  { id: 6, status: 'enabled', targetType: 'member', targetValue: 'kyc_pending_01', action: 'å¼·åˆ¶å°å…¥KYCé é¢', reason: 'è§¸ç™¼é«˜é¡å‡ºæ¬¾å¯©æ ¸', updatedAt: '2025-08-04 15:00', operator: 'system_auto' },
];

const ACTIONS_LIST = ['ç¦æ­¢å‡ºæ¬¾', 'ç¦æ­¢å­˜æ¬¾', 'ç¦æ­¢æ‰€æœ‰éŠæˆ²', 'ç¦æ­¢é ˜å–å„ªæƒ ', 'å¼·åˆ¶å°å…¥KYCé é¢', 'ç¦æ­¢ç™»å…¥', 'ç¦æ­¢è¨»å†Š'];

// --- é è¨­åŸå› å°ç…§è¡¨ ---
const PRESET_REASONS = {
  'ç¦æ­¢å‡ºæ¬¾': ['é«˜é »ç•°å¸¸äº¤æ˜“', 'ç–‘ä¼¼æ´—éŒ¢è¡Œç‚º', 'å¸³æˆ¶å¸æ³•å‡çµ', 'è§¸ç™¼é¢¨æ§å¯©æ ¸'],
  'ç¦æ­¢å­˜æ¬¾': ['å­˜æ¬¾ç®¡é“ç•°å¸¸', 'ç–‘ä¼¼ç›œåˆ·'],
  'ç¦æ­¢æ‰€æœ‰éŠæˆ²': ['ä½¿ç”¨å¤–æ›ç¨‹å¼', 'é•åéŠæˆ²å…¬å¹³æ€§åŸå‰‡', 'å°å£“æˆ–å¥—åˆ©è¡Œç‚º'],
  'ç¦æ­¢é ˜å–å„ªæƒ ': ['æ¿«ç”¨å„ªæƒ æ¢æ¬¾', 'é‡è¤‡ç”³è«‹å„ªæƒ ', 'éæœ¬äººç”³è«‹'],
  'å¼·åˆ¶å°å…¥KYCé é¢': ['è§¸ç™¼é«˜é¡å‡ºæ¬¾å¯©æ ¸', 'å¸³æˆ¶è³‡è¨Šä¸å®Œæ•´', 'å®šæœŸå®‰å…¨æŠ½æŸ¥'],
  'ç¦æ­¢ç™»å…¥': ['å¸³è™Ÿè¢«ç›œç”¨', 'åš´é‡é•åç¶²ç«™æ¢æ¬¾', 'æ‡‰ä¸»ç®¡æ©Ÿé—œè¦æ±‚'],
  'ç¦æ­¢è¨»å†Š': ['åƒåœ¾è¨»å†Šè¡Œç‚º', 'é‡è¤‡è¨»å†Š', 'æƒ¡æ„ IP ä¾†æº'],
};


// --- ä¸»æ‡‰ç”¨ç¨‹å¼çµ„ä»¶ (Main App Component) ---
export default function App() {
  const [rules, setRules] = useState(initialRules);
  const [filters, setFilters] = useState({
    keyword: '',
    targetType: 'all',
    action: 'all',
    status: 'all',
  });
  const [appliedFilters, setAppliedFilters] = useState(filters);

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingRule, setEditingRule] = useState(null);
  
  const [isConfirmOpen, setIsConfirmOpen] = useState(false);
  const [ruleToDelete, setRuleToDelete] = useState(null);

  // --- âœ¨ HYDRATION çµ‚æ¥µä¿®å¾©ï¼šä½¿ç”¨ mounted ç‹€æ…‹ ---
  // é€™å€‹ç‹€æ…‹ç¢ºä¿åªåœ¨å®¢æˆ¶ç«¯ç€è¦½å™¨ä¸Šæ‰æ¸²æŸ“å®Œæ•´å…§å®¹ï¼Œé¿å…ä¼ºæœå™¨èˆ‡å®¢æˆ¶ç«¯æ¸²æŸ“ä¸åŒ¹é…ã€‚
  const [isMounted, setIsMounted] = useState(false);
  useEffect(() => {
    setIsMounted(true);
  }, []);


  const nextId = useRef(Math.max(...initialRules.map(r => r.id)) + 1);


  const filteredRules = useMemo(() => {
    return rules.filter(rule => {
      const keywordMatch = !appliedFilters.keyword || rule.targetValue.toLowerCase().includes(appliedFilters.keyword.toLowerCase());
      const targetTypeMatch = appliedFilters.targetType === 'all' || rule.targetType === appliedFilters.targetType;
      const actionMatch = appliedFilters.action === 'all' || rule.action === appliedFilters.action;
      const statusMatch = appliedFilters.status === 'all' || rule.status === appliedFilters.status;
      return keywordMatch && targetTypeMatch && actionMatch && statusMatch;
    });
  }, [rules, appliedFilters]);

  // --- äº‹ä»¶è™•ç†å‡½å¼ (Event Handlers) ---
  const handleFilterChange = (e) => {
    const { name, value } = e.target;
    setFilters(prev => ({ ...prev, [name]: value }));
  };

  const handleSearch = () => {
    setAppliedFilters(filters);
  };

  const handleResetFilters = () => {
    const initialFilters = {
      keyword: '',
      targetType: 'all',
      action: 'all',
      status: 'all',
    };
    setFilters(initialFilters);
    setAppliedFilters(initialFilters);
  };

  const handleOpenModal = (rule = null) => {
    setEditingRule(rule);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setEditingRule(null);
  };

  const handleSaveRule = (ruleToSave) => {
    const now = new Date();
    const formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

    const targets = ruleToSave.targetValue.split('\n').filter(t => t.trim() !== '');
    
    if (editingRule) {
      // ç·¨è¼¯æ¨¡å¼ (åªè™•ç†ç¬¬ä¸€å€‹ç›®æ¨™)
      const updatedRule = { ...rules.find(r => r.id === editingRule.id), ...ruleToSave, targetValue: targets[0], updatedAt: formattedDate, operator: 'admin_you' };
      setRules(rules.map(r => r.id === editingRule.id ? updatedRule : r));
    } else {
      // æ–°å¢æ¨¡å¼ (æ‰¹æ¬¡)
      const newRules = targets.map(target => {
        const newId = nextId.current;
        nextId.current++;
        return {
          id: newId, 
          ...ruleToSave,
          targetValue: target.trim(),
          status: 'enabled',
          updatedAt: formattedDate, 
          operator: 'admin_you'
        };
      });
      setRules([...newRules, ...rules]);
    }
    handleCloseModal();
  };

  const handleToggleStatus = (id) => {
    setRules(rules.map(r => 
      r.id === id ? { ...r, status: r.status === 'enabled' ? 'disabled' : 'enabled' } : r
    ));
  };

  const handleOpenConfirm = (id) => {
    setRuleToDelete(id);
    setIsConfirmOpen(true);
  };

  const handleCloseConfirm = () => {
    setIsConfirmOpen(false);
    setRuleToDelete(null);
  };

  const handleDeleteRule = () => {
    if (ruleToDelete) {
      setRules(rules.filter(r => r.id !== ruleToDelete));
      handleCloseConfirm();
    }
  };
  
  const handleExport = () => {
    const headers = ['ç‹€æ…‹', 'ç›®æ¨™é¡å‹', 'ç›®æ¨™å€¼', 'åŸ·è¡Œå‹•ä½œ', 'åŸå› ', 'æ›´æ–°æ™‚é–“', 'æ“ä½œäºº'];
    const rows = filteredRules.map(rule => [
        rule.status === 'enabled' ? 'å•Ÿç”¨' : 'åœç”¨',
        rule.targetType === 'member' ? 'æœƒå“¡å¸³è™Ÿ' : 'IP ä½å€',
        rule.targetValue,
        rule.action,
        rule.reason,
        rule.updatedAt,
        rule.operator
    ]);

    let csvContent = "data:text/csv;charset=utf-8," 
        + headers.join(",") + "\n" 
        + rows.map(e => e.join(",")).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    const date = new Date().toISOString().slice(0, 10);
    link.setAttribute("download", `risk_rules_export_${date}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- âœ¨ HYDRATION çµ‚æ¥µä¿®å¾©ï¼šåœ¨ isMounted è®Šç‚º true ä¹‹å‰ï¼Œä¸æ¸²æŸ“ä»»ä½•å…§å®¹ ---
  if (!isMounted) {
    return null;
  }

  return (
    <div className="bg-gray-100 min-h-screen font-sans text-gray-800">
      <div className="container mx-auto p-4 sm:p-6 lg:p-8">
        <Header />
        <DashboardIntegrationInfo />
        <div className="bg-white rounded-xl shadow-lg p-6">
          <FilterSection 
            filters={filters} 
            onFilterChange={handleFilterChange} 
            onSearch={handleSearch}
            onReset={handleResetFilters} 
            onAddNew={() => handleOpenModal()}
            onExport={handleExport}
          />
          <RulesTable 
            rules={filteredRules}
            onEdit={handleOpenModal}
            onDelete={handleOpenConfirm}
            onToggleStatus={handleToggleStatus}
          />
        </div>
      </div>
      {isModalOpen && (
        <RuleModal 
          rule={editingRule} 
          onClose={handleCloseModal} 
          onSave={handleSaveRule} 
        />
      )}
      {isConfirmOpen && (
        <ConfirmationModal
          onClose={handleCloseConfirm}
          onConfirm={handleDeleteRule}
        />
      )}
    </div>
  );
}

// --- å­çµ„ä»¶ (Sub-components) ---

function Header() {
  return (
    <header className="mb-6">
      <h1 className="text-3xl font-bold text-gray-900">ğŸª é¢¨æ§è¦å‰‡ç®¡ç†</h1>
      <p className="text-gray-600 mt-1">çµ±ä¸€ç®¡ç†æœƒå“¡å¸³è™Ÿèˆ‡ IP ä½å€çš„é™åˆ¶è¦å‰‡ã€‚</p>
    </header>
  );
}

function DashboardIntegrationInfo() {
    return (
        <div className="mb-6 bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
            <div className="flex">
                <div className="py-1"><Info className="h-6 w-6 text-blue-500" /></div>
                <div className="ml-3">
                    <h4 className="text-md font-semibold text-blue-800">å¦‚ä½•é€£å‹•è‡³ã€Œæœƒå“¡å„€è¡¨æ¿ã€ï¼Ÿ</h4>
                    <p className="text-sm text-blue-700 mt-1">
                        æ­¤è™•å»ºç«‹çš„è¦å‰‡å°‡å³æ™‚åŒæ­¥ã€‚åœ¨æœƒå“¡å„€è¡¨æ¿ä¸­ï¼Œæ‚¨æœƒçœ‹åˆ°ï¼š<br/>
                        - <strong>æœƒå“¡å¸³è™Ÿ</strong>è¢«å‘½ä¸­ï¼šé¡¯ç¤º ğŸ”’ <span className="font-semibold">é¢¨éšªç®¡åˆ¶ä¸­</span> æ¨™ç±¤ã€‚<br/>
                        - <strong>ç™»å…¥ IP</strong> è¢«å‘½ä¸­ï¼šåœ¨å°æ‡‰ IP æ—é¡¯ç¤º âš ï¸ è­¦ç¤ºåœ–ç¤ºã€‚
                    </p>
                </div>
            </div>
        </div>
    );
}

function FilterSection({ filters, onFilterChange, onSearch, onReset, onAddNew, onExport }) {
  return (
    <div className="mb-6 space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        {/* æœå°‹æ¬„ä½ */}
        <div className="lg:col-span-2">
          <label htmlFor="keyword" className="block text-sm font-medium text-gray-700 mb-1">æœå°‹ç›®æ¨™å€¼</label>
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
            <input
              type="text"
              name="keyword"
              id="keyword"
              placeholder="è¼¸å…¥æœƒå“¡å¸³è™Ÿæˆ– IP ä½å€..."
              value={filters.keyword}
              onChange={onFilterChange}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition"
            />
          </div>
        </div>
        
        {/* ç›®æ¨™é¡å‹ */}
        <div>
          <label htmlFor="targetType" className="block text-sm font-medium text-gray-700 mb-1">ç›®æ¨™é¡å‹</label>
          <select name="targetType" id="targetType" value={filters.targetType} onChange={onFilterChange} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="all">å…¨éƒ¨é¡å‹</option>
            <option value="member">æœƒå“¡å¸³è™Ÿ</option>
            <option value="ip">IP ä½å€</option>
          </select>
        </div>

        {/* åŸ·è¡Œå‹•ä½œ */}
        <div>
          <label htmlFor="action" className="block text-sm font-medium text-gray-700 mb-1">åŸ·è¡Œå‹•ä½œ</label>
          <select name="action" id="action" value={filters.action} onChange={onFilterChange} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="all">å…¨éƒ¨å‹•ä½œ</option>
            {ACTIONS_LIST.map(act => <option key={act} value={act}>{act}</option>)}
          </select>
        </div>
        
        {/* ç‹€æ…‹ */}
        <div>
          <label htmlFor="status" className="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
          <select name="status" id="status" value={filters.status} onChange={onFilterChange} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="enabled">å•Ÿç”¨</option>
            <option value="disabled">åœç”¨</option>
          </select>
        </div>
      </div>
      
      {/* æ“ä½œæŒ‰éˆ• */}
      <div className="flex flex-wrap items-center justify-between gap-4 pt-4 border-t border-gray-200">
         <div className="flex items-center gap-2">
            <button onClick={onSearch} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm">
                <Search size={16} />
                æœå°‹
            </button>
            <button onClick={onReset} className="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">
                <RotateCcw size={16} />
                é‡è¨­
            </button>
         </div>
         <div className="flex items-center gap-2">
            <button onClick={onExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm">
                <Download size={16} />
                åŒ¯å‡º
            </button>
            <button onClick={onAddNew} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                <Plus size={16} />
                æ–°å¢è¦å‰‡
            </button>
         </div>
      </div>
    </div>
  );
}

function RulesTable({ rules, onEdit, onDelete, onToggleStatus }) {
  return (
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›®æ¨™é¡å‹</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›®æ¨™å€¼</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸ·è¡Œå‹•ä½œ</th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸå› </th>
            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ›´æ–°æ™‚é–“ / æ“ä½œäºº</th>
            <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {rules.length > 0 ? rules.map(rule => (
            <tr key={rule.id} className="hover:bg-gray-50 transition-colors">
              <td className="px-6 py-4 whitespace-nowrap">
                <StatusToggle status={rule.status} onToggle={() => onToggleStatus(rule.id)} />
              </td>
              <td className="px-6 py-4 whitespace-nowrap">
                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${rule.targetType === 'member' ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}`}>
                  {rule.targetType === 'member' ? 'æœƒå“¡å¸³è™Ÿ' : 'IP ä½å€'}
                </span>
              </td>
              <td className="px-6 py-4 whitespace-nowrap font-mono text-sm text-gray-900">{rule.targetValue}</td>
              <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-semibold">{rule.action}</td>
              <td className="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title={rule.reason}>{rule.reason}</td>
              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div>{rule.updatedAt}</div>
                <div className="text-xs text-gray-400">{rule.operator}</div>
              </td>
              <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                <div className="flex items-center justify-center gap-4">
                  <button onClick={() => onEdit(rule)} className="text-indigo-600 hover:text-indigo-900" title="ç·¨è¼¯">
                    <Edit size={18} />
                  </button>
                  <button onClick={() => onDelete(rule.id)} className="text-red-600 hover:text-red-900" title="åˆªé™¤">
                    <Trash2 size={18} />
                  </button>
                </div>
              </td>
            </tr>
          )) : (
            <tr>
              <td colSpan="7" className="text-center py-16 text-gray-500">
                <p className="font-semibold">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¦å‰‡</p>
                <p className="text-sm mt-1">è«‹å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–é‡è¨­ã€‚</p>
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  );
}

function StatusToggle({ status, onToggle }) {
  const isEnabled = status === 'enabled';
  return (
    <div className="flex items-center gap-2">
      <button
        onClick={onToggle}
        className={`relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 ${isEnabled ? 'bg-green-600' : 'bg-gray-300'}`}
      >
        <span
          className={`inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${isEnabled ? 'translate-x-5' : 'translate-x-0'}`}
        />
      </button>
      <span className={`text-sm font-medium ${isEnabled ? 'text-green-700' : 'text-gray-600'}`}>
        {isEnabled ? 'å•Ÿç”¨' : 'åœç”¨'}
      </span>
    </div>
  );
}

function RuleModal({ rule, onClose, onSave }) {
  const [formData, setFormData] = useState({
    targetType: rule?.targetType || 'member',
    targetValue: rule?.targetValue || '',
    action: rule?.action || '',
    reason: rule?.reason || '',
    isPermanent: true,
    expiryDate: '',
  });

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleActionChange = (e) => {
    const newAction = e.target.value;
    setFormData(prev => ({
      ...prev,
      action: newAction,
      reason: '' // æ¸…ç©ºåŸå› ä»¥ä¾¿é¸æ“‡é è¨­å€¼
    }));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.action || !formData.reason || !formData.targetValue) {
      // æ”¹ç”¨æ›´å‹å–„çš„æç¤ºæ–¹å¼ï¼Œè€Œéç€è¦½å™¨åŸç”Ÿçš„ alert
      // åœ¨æ­¤åŸå‹ä¸­æˆ‘å€‘æš«æ™‚ä¿ç•™ alertï¼Œä½†åœ¨æ­£å¼ç”¢å“ä¸­æ‡‰æ›¿æ›ç‚º UI å…ƒä»¶
      alert('ç›®æ¨™å€¼ã€åŸ·è¡Œå‹•ä½œèˆ‡åŸå› ç‚ºå¿…å¡«æ¬„ä½ã€‚');
      return;
    }
    onSave(formData);
  };

  const currentPresetReasons = PRESET_REASONS[formData.action] || [];

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all">
        <form onSubmit={handleSubmit}>
          <div className="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 className="text-xl font-semibold text-gray-900">{rule ? 'ç·¨è¼¯è¦å‰‡' : 'æ–°å¢è¦å‰‡'}</h3>
            <button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={24} /></button>
          </div>
          <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ç›®æ¨™é¡å‹</label>
              <div className="flex">
                <button type="button" onClick={() => setFormData({...formData, targetType: 'member'})} className={`px-4 py-2 rounded-l-lg border ${formData.targetType === 'member' ? 'bg-indigo-600 text-white border-indigo-600 z-10' : 'bg-white hover:bg-gray-50'}`}>æœƒå“¡å¸³è™Ÿ</button>
                <button type="button" onClick={() => setFormData({...formData, targetType: 'ip'})} className={`px-4 py-2 -ml-px rounded-r-lg border ${formData.targetType === 'ip' ? 'bg-indigo-600 text-white border-indigo-600 z-10' : 'bg-white hover:bg-gray-50'}`}>IP ä½å€</button>
              </div>
            </div>
            <div>
              <label htmlFor="targetValue" className="block text-sm font-medium text-gray-700">ç›®æ¨™å€¼ <span className="text-red-500">*</span></label>
              <textarea
                name="targetValue"
                id="targetValue"
                rows="3"
                value={formData.targetValue}
                onChange={handleInputChange}
                className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder={rule ? "ç·¨è¼¯æ¨¡å¼ä¸‹ä¸€æ¬¡åƒ…èƒ½ä¿®æ”¹ä¸€å€‹ç›®æ¨™" : "å¯è¼¸å…¥å–®ä¸€æˆ–å¤šå€‹ç›®æ¨™ï¼Œæ¯è¡Œä¸€å€‹ã€‚"}
                required
                disabled={!!rule}
              />
            </div>
            <div>
              <label htmlFor="action" className="block text-sm font-medium text-gray-700">åŸ·è¡Œå‹•ä½œ <span className="text-red-500">*</span></label>
              <select
                name="action"
                id="action"
                value={formData.action}
                onChange={handleActionChange}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                required
              >
                <option value="" disabled>è«‹é¸æ“‡ä¸€å€‹å‹•ä½œ...</option>
                {ACTIONS_LIST.map(act => <option key={act} value={act}>{act}</option>)}
              </select>
            </div>
            <div>
              <label htmlFor="reason" className="block text-sm font-medium text-gray-700">åŸå›  <span className="text-red-500">*</span></label>
              <input
                type="text"
                name="reason"
                id="reason"
                list="preset-reasons"
                value={formData.reason}
                onChange={handleInputChange}
                className="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                placeholder="å¯é¸æ“‡é è¨­æˆ–è‡ªè¡Œè¼¸å…¥åŸå› "
                required
              />
              <datalist id="preset-reasons">
                {currentPresetReasons.map(r => <option key={r} value={r} />)}
              </datalist>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">æœ‰æ•ˆæœŸé™</label>
              <div className="mt-2 space-y-2">
                <div className="flex items-center">
                  <input
                    id="isPermanent"
                    name="isPermanent"
                    type="checkbox"
                    checked={formData.isPermanent}
                    onChange={handleInputChange}
                    className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                  />
                  <label htmlFor="isPermanent" className="ml-2 block text-sm text-gray-900">
                    æ°¸ä¹…æœ‰æ•ˆ
                  </label>
                </div>
                {!formData.isPermanent && (
                  <input
                    type="date"
                    name="expiryDate"
                    id="expiryDate"
                    value={formData.expiryDate}
                    onChange={handleInputChange}
                    className="block w-full border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                  />
                )}
              </div>
            </div>
          </div>
          <div className="p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
            <button type="button" onClick={onClose} className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">å–æ¶ˆ</button>
            <button type="submit" className="px-4 py-2 bg-indigo-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-indigo-700 shadow-sm">å„²å­˜</button>
          </div>
        </form>
      </div>
    </div>
  );
}

function ConfirmationModal({ onClose, onConfirm }) {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-all p-6 text-center">
        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
          <AlertTriangle className="h-6 w-6 text-red-600" aria-hidden="true" />
        </div>
        <h3 className="text-lg font-medium text-gray-900 mt-4">ç¢ºèªåˆªé™¤</h3>
        <p className="text-sm text-gray-500 mt-2">
          æ‚¨ç¢ºå®šè¦åˆªé™¤é€™æ¢è¦å‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚
        </p>
        <div className="mt-6 flex justify-center gap-4">
          <button
            type="button"
            className="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50"
            onClick={onClose}
          >
            å–æ¶ˆ
          </button>
          <button
            type="button"
            className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700"
            onClick={onConfirm}
          >
            ç¢ºèªåˆªé™¤
          </button>
        </div>
      </div>
    </div>
  );
}
