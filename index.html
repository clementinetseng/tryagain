<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>風控規則管理 - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* 自定義切換開關樣式 */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #34d399;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #34d399;
        }
        /* 分段控件樣式 */
        .segment-control input:checked + label {
            background-color: #fff;
            color: #1e40af;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- 頁面標題 -->
        <h1 class="text-3xl font-bold text-gray-800 mb-6">🪐 風控規則管理</h1>

        <!-- 搜尋與篩選 -->
        <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">搜尋與篩選</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <input id="search-input" type="text" placeholder="輸入會員帳號或 IP 位址..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                
                <select id="filter-target-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">目標類型: 全部</option>
                    <option value="會員帳號">會員帳號</option>
                    <option value="IP 位址">IP 位址</option>
                </select>

                <select id="filter-action" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">執行動作: 全部</option>
                    <option value="禁止出款">禁止出款</option>
                    <option value="禁止存款">禁止存款</option>
                    <option value="禁止所有遊戲">禁止所有遊戲</option>
                    <option value="禁止領取優惠">禁止領取優惠</option>
                    <option value="強制導入KYC頁面">強制導入KYC頁面</option>
                    <option value="禁止登入">禁止登入</option>
                    <option value="禁止註冊">禁止註冊</option>
                </select>

                <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">狀態: 全部</option>
                    <option value="enabled">啟用</option>
                    <option value="disabled">停用</option>
                </select>
            </div>
            <div class="flex flex-wrap items-center justify-between mt-4">
                <div class="flex items-center space-x-2">
                    <button id="search-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">搜尋</button>
                    <button id="reset-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">重設</button>
                </div>
                <div class="flex items-center space-x-2 mt-4 md:mt-0">
                    <button id="export-btn" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">匯出 CSV</button>
                    <button id="add-rule-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">新增規則</button>
                </div>
            </div>
        </div>

        <!-- 規則列表 -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <h2 class="text-lg font-semibold text-gray-700 p-6">規則列表</h2>
            <div class="overflow-x-auto">
                <table class="w-full min-w-max text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">狀態</th>
                            <th scope="col" class="px-6 py-3">目標類型</th>
                            <th scope="col" class="px-6 py-3">目標值</th>
                            <th scope="col" class="px-6 py-3">執行動作</th>
                            <th scope="col" class="px-6 py-3">原因</th>
                            <th scope="col" class="px-6 py-3">更新時間 / 操作人</th>
                            <th scope="col" class="px-6 py-3 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table-body">
                        <!-- 規則列將由 JS 動態生成 -->
                    </tbody>
                </table>
            </div>
            <div id="empty-state" class="hidden text-center py-16">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">找不到規則</h3>
                <p class="mt-1 text-sm text-gray-500">找不到符合條件的規則。請嘗試調整篩選條件或重設。</p>
            </div>
        </div>

        <!-- 會員儀表板連動說明 -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-6 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <span class="font-bold">儀表板連動說明：</span>
                        本系統建立的規則將即時同步至「會員儀表板」。若會員帳號被命中，將顯示 <span class="font-mono bg-gray-200 px-1 rounded">🔒 風險管制中</span> 標籤。若登入 IP 被命中，將在 IP 旁顯示 <span class="font-mono bg-gray-200 px-1 rounded">⚠️</span> 警示。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯規則 Modal -->
    <div id="rule-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all">
            <form id="rule-form">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-800">新增規則</h3>
                </div>
                <div class="p-6 space-y-6">
                    <input type="hidden" id="rule-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">目標類型</label>
                        <div class="segment-control relative w-full flex rounded-lg bg-gray-200 p-1">
                            <input type="radio" id="target-type-member" name="targetType" value="會員帳號" class="sr-only" checked>
                            <label for="target-type-member" class="flex-1 text-center py-2 rounded-md cursor-pointer transition-colors duration-200 ease-in-out text-gray-600">會員帳號</label>
                            <input type="radio" id="target-type-ip" name="targetType" value="IP 位址" class="sr-only">
                            <label for="target-type-ip" class="flex-1 text-center py-2 rounded-md cursor-pointer transition-colors duration-200 ease-in-out text-gray-600">IP 位址</label>
                        </div>
                    </div>

                    <div>
                        <label for="target-value" class="block text-sm font-medium text-gray-700">目標值</label>
                        <textarea id="target-value" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="輸入會員帳號...&#10;支援批次新增，每行一個。"></textarea>
                    </div>

                    <div>
                        <label for="action" class="block text-sm font-medium text-gray-700">執行動作</label>
                        <select id="action" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="" disabled selected>請選擇一個動作</option>
                            <option value="禁止出款">禁止出款</option>
                            <option value="禁止存款">禁止存款</option>
                            <option value="禁止所有遊戲">禁止所有遊戲</option>
                            <option value="禁止領取優惠">禁止領取優惠</option>
                            <option value="強制導入KYC頁面">強制導入KYC頁面</option>
                            <option value="禁止登入">禁止登入</option>
                            <option value="禁止註冊">禁止註冊</option>
                        </select>
                    </div>

                    <div>
                        <label for="reason" class="block text-sm font-medium text-gray-700">原因</label>
                        <input id="reason" list="reason-suggestions" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="可選擇預設或自行輸入原因">
                        <datalist id="reason-suggestions">
                            <!-- 選項將由 JS 動態更新 -->
                        </datalist>
                    </div>
                    
                    <div>
                        <label for="expiry-date" class="block text-sm font-medium text-gray-700">有效期限</label>
                        <div class="flex items-center mt-1 space-x-4">
                            <input type="date" id="expiry-date" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm disabled:bg-gray-100">
                            <div class="flex items-center">
                                <input id="permanent-expiry" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="permanent-expiry" class="ml-2 block text-sm text-gray-900">永久有效</label>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="bg-gray-50 px-6 py-3 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">取消</button>
                    <button type="submit" id="save-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 刪除確認 Modal -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">確認刪除</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">您確定要刪除這條規則嗎？此操作無法復原。</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">確認刪除</button>
                <button type="button" id="cancel-delete-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">取消</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 初始資料 ---
            let rulesData = [
                { id: 1, status: 'enabled', targetType: '會員帳號', targetValue: 'user_cheater01', action: '禁止出款', reason: '多帳號套利行為', updated: '2025/08/05 14:30', operator: 'risk_manager_A' },
                { id: 2, status: 'enabled', targetType: 'IP 位址', targetValue: '192.168.1.101', action: '禁止註冊', reason: '垃圾註冊行為', updated: '2025/08/05 11:20', operator: 'risk_manager_B' },
                { id: 3, status: 'disabled', targetType: '會員帳號', targetValue: 'temp_block_user', action: '禁止登入', reason: '帳號異常活動調查', updated: '2025/08/04 18:00', operator: 'system_admin' },
                { id: 4, status: 'enabled', targetType: 'IP 位址', targetValue: '203.0.113.55', action: '禁止登入', reason: '已知的惡意攻擊來源', updated: '2025/08/03 09:10', operator: 'risk_manager_A' },
                { id: 5, status: 'enabled', targetType: '會員帳號', targetValue: 'promo_abuser_99', action: '禁止領取優惠', reason: '濫用優惠活動', updated: '2025/08/02 16:45', operator: 'risk_manager_B' },
                { id: 6, status: 'enabled', targetType: '會員帳號', targetValue: 'kyc_pending_01', action: '強制導入KYC頁面', reason: '高風險交易觸發', updated: '2025/08/01 12:00', operator: 'system_auto' },
            ];

            const reasonSuggestions = {
                '禁止出款': ['多帳號套利行為', '疑似洗錢', '風控部門審核'],
                '禁止存款': ['存款來源可疑', '交易失敗次數過多'],
                '禁止所有遊戲': ['使用外掛程式', '違反遊戲公平性'],
                '禁止領取優惠': ['濫用優惠活動', '不符合活動資格'],
                '強制導入KYC頁面': ['高風險交易觸發', '帳戶資訊不完整'],
                '禁止登入': ['帳號異常活動調查', '違反使用者條款', '帳號被盜用'],
                '禁止註冊': ['垃圾註冊行為', '惡意IP註冊', '重複註冊'],
            };

            // --- DOM 元素 ---
            const tableBody = document.getElementById('rules-table-body');
            const emptyState = document.getElementById('empty-state');
            const searchInput = document.getElementById('search-input');
            const filterTargetType = document.getElementById('filter-target-type');
            const filterAction = document.getElementById('filter-action');
            const filterStatus = document.getElementById('filter-status');
            const searchBtn = document.getElementById('search-btn');
            const resetBtn = document.getElementById('reset-btn');
            const addRuleBtn = document.getElementById('add-rule-btn');

            const modal = document.getElementById('rule-modal');
            const modalTitle = document.getElementById('modal-title');
            const ruleForm = document.getElementById('rule-form');
            const ruleIdInput = document.getElementById('rule-id');
            const targetTypeMemberRadio = document.getElementById('target-type-member');
            const targetTypeIpRadio = document.getElementById('target-type-ip');
            const targetValueTextarea = document.getElementById('target-value');
            const actionSelect = document.getElementById('action');
            const reasonInput = document.getElementById('reason');
            const reasonSuggestionsDatalist = document.getElementById('reason-suggestions');
            const expiryDateInput = document.getElementById('expiry-date');
            const permanentExpiryCheckbox = document.getElementById('permanent-expiry');
            const cancelBtn = document.getElementById('cancel-btn');
            const saveBtn = document.getElementById('save-btn');

            const deleteModal = document.getElementById('delete-confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            let ruleToDeleteId = null;

            // --- 函數 ---

            // 渲染表格
            const renderTable = (rules) => {
                tableBody.innerHTML = '';
                if (rules.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                emptyState.classList.add('hidden');

                rules.forEach(rule => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <label for="status-toggle-${rule.id}" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="status-toggle-${rule.id}" class="sr-only toggle-checkbox" ${rule.status === 'enabled' ? 'checked' : ''} data-id="${rule.id}">
                                    <div class="block bg-gray-300 w-12 h-6 rounded-full toggle-label transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                                <div class="ml-3 text-gray-700 text-sm font-medium">${rule.status === 'enabled' ? '<span class="text-green-600">啟用</span>' : '<span class="text-gray-500">停用</span>'}</div>
                            </label>
                        </td>
                        <td class="px-6 py-4">${rule.targetType}</td>
                        <td class="px-6 py-4 font-mono text-gray-800">${rule.targetValue}</td>
                        <td class="px-6 py-4">${rule.action}</td>
                        <td class="px-6 py-4">${rule.reason}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-800">${rule.updated}</div>
                            <div class="text-xs text-gray-500">${rule.operator}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button class="font-medium text-blue-600 hover:underline mr-4 edit-btn" data-id="${rule.id}">編輯</button>
                            <button class="font-medium text-red-600 hover:underline delete-btn" data-id="${rule.id}">刪除</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            };

            // 篩選和搜尋
            const filterAndSearch = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const targetType = filterTargetType.value;
                const action = filterAction.value;
                const status = filterStatus.value;

                const filteredRules = rulesData.filter(rule => {
                    const matchSearch = !searchTerm || rule.targetValue.toLowerCase().includes(searchTerm);
                    const matchTargetType = targetType === 'all' || rule.targetType === targetType;
                    const matchAction = action === 'all' || rule.action === action;
                    const matchStatus = status === 'all' || rule.status === status;
                    return matchSearch && matchTargetType && matchAction && matchStatus;
                });
                renderTable(filteredRules);
            };

            // 開啟 Modal
            const openModal = (rule = null) => {
                ruleForm.reset();
                if (rule) { // 編輯模式
                    modalTitle.textContent = '編輯規則';
                    ruleIdInput.value = rule.id;
                    if (rule.targetType === 'IP 位址') {
                        targetTypeIpRadio.checked = true;
                    } else {
                        targetTypeMemberRadio.checked = true;
                    }
                    targetValueTextarea.value = rule.targetValue;
                    targetValueTextarea.readOnly = true;
                    targetValueTextarea.placeholder = '編輯模式下不可修改目標值';
                    actionSelect.value = rule.action;
                    reasonInput.value = rule.reason;
                    // 這裡可以加入有效期限的邏輯
                    permanentExpiryCheckbox.checked = true; // 預設
                    handleExpiryDateState();
                    updateReasonSuggestions();
                } else { // 新增模式
                    modalTitle.textContent = '新增規則';
                    ruleIdInput.value = '';
                    targetTypeMemberRadio.checked = true;
                    targetValueTextarea.readOnly = false;
                    targetValueTextarea.placeholder = '輸入會員帳號...\n支援批次新增，每行一個。';
                    permanentExpiryCheckbox.checked = true;
                    handleExpiryDateState();
                    updateReasonSuggestions();
                }
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            // 關閉 Modal
            const closeModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };

            // 更新原因建議
            const updateReasonSuggestions = () => {
                const selectedAction = actionSelect.value;
                const suggestions = reasonSuggestions[selectedAction] || [];
                reasonSuggestionsDatalist.innerHTML = suggestions.map(s => `<option value="${s}"></option>`).join('');
            };

            // 處理有效期限輸入框狀態
            const handleExpiryDateState = () => {
                expiryDateInput.disabled = permanentExpiryCheckbox.checked;
                if (permanentExpiryCheckbox.checked) {
                    expiryDateInput.value = '';
                }
            };
            
            // 處理目標值輸入框的 placeholder
            const handleTargetValuePlaceholder = () => {
                if (targetValueTextarea.readOnly) return; // 編輯模式下不變
                if(targetTypeIpRadio.checked) {
                    targetValueTextarea.placeholder = '輸入 IP 位址...\n支援批次新增，每行一個。';
                } else {
                    targetValueTextarea.placeholder = '輸入會員帳號...\n支援批次新增，每行一個。';
                }
            };

            // --- 事件監聽 ---
            searchBtn.addEventListener('click', filterAndSearch);
            resetBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterTargetType.value = 'all';
                filterAction.value = 'all';
                filterStatus.value = 'all';
                filterAndSearch();
            });
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    filterAndSearch();
                }
            });

            addRuleBtn.addEventListener('click', () => openModal());
            cancelBtn.addEventListener('click', closeModal);

            actionSelect.addEventListener('change', updateReasonSuggestions);
            permanentExpiryCheckbox.addEventListener('change', handleExpiryDateState);
            targetTypeMemberRadio.addEventListener('change', handleTargetValuePlaceholder);
            targetTypeIpRadio.addEventListener('change', handleTargetValuePlaceholder);

            // 表單提交
            ruleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = ruleIdInput.value;
                const targetValues = targetValueTextarea.value.trim().split('\n').filter(val => val);
                const newRuleData = {
                    targetType: document.querySelector('input[name="targetType"]:checked').value,
                    action: actionSelect.value,
                    reason: reasonInput.value,
                    // 有效期限邏輯可在此添加
                    updated: new Date().toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/-/g, '/') + ' ' + new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                    operator: 'current_user' // 應從實際登入資訊取得
                };

                if (id) { // 編輯
                    const index = rulesData.findIndex(r => r.id == id);
                    if (index !== -1) {
                        rulesData[index] = { ...rulesData[index], ...newRuleData };
                    }
                } else { // 新增
                    targetValues.forEach(value => {
                        const newId = rulesData.length > 0 ? Math.max(...rulesData.map(r => r.id)) + 1 : 1;
                        rulesData.unshift({
                            id: newId,
                            status: 'enabled',
                            targetValue: value,
                            ...newRuleData
                        });
                    });
                }
                closeModal();
                filterAndSearch();
                // 顯示成功訊息
                // alert('規則已成功儲存。'); // 實際應用中會用更好看的提示框
            });

            // 事件代理 (編輯、刪除、狀態切換)
            tableBody.addEventListener('click', (e) => {
                const target = e.target;
                
                // 狀態切換
                if (target.classList.contains('toggle-checkbox')) {
                    const id = target.dataset.id;
                    const index = rulesData.findIndex(r => r.id == id);
                    if (index !== -1) {
                        rulesData[index].status = target.checked ? 'enabled' : 'disabled';
                        rulesData[index].updated = new Date().toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/-/g, '/') + ' ' + new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        rulesData[index].operator = 'current_user';
                        filterAndSearch();
                    }
                }

                // 編輯按鈕
                if (target.classList.contains('edit-btn')) {
                    const id = target.dataset.id;
                    const rule = rulesData.find(r => r.id == id);
                    if (rule) {
                        openModal(rule);
                    }
                }

                // 刪除按鈕
                if (target.classList.contains('delete-btn')) {
                    ruleToDeleteId = target.dataset.id;
                    deleteModal.classList.remove('hidden');
                    deleteModal.classList.add('flex');
                }
            });

            // 刪除確認 Modal 事件
            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
                ruleToDeleteId = null;
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (ruleToDeleteId) {
                    rulesData = rulesData.filter(r => r.id != ruleToDeleteId);
                    filterAndSearch();
                    // alert('規則已成功刪除。'); // 實際應用中會用更好看的提示框
                }
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('flex');
                ruleToDeleteId = null;
            });

            // --- 初始渲染 ---
            renderTable(rulesData);
        });
    </script>

</body>
</html>
